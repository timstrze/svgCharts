"use strict";angular.module("svgChartsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngMaterial","ngMessages","ngMdIcons"]).config(["$routeProvider",function(a){a.when("/svg-charts/demo",{templateUrl:"views/routes/main.html",controller:"MainController",controllerAs:"ctrl"})}]),angular.module("svgChartsApp").controller("MainController",["$http",function(a){this.init=function(){var b=this;this.symbol={},this.selectedChart="candlestick-chart",this.selectedExtras=[],a.get("json/historical-data.json").then(function(a){b.symbol.historicalData=a.data.query.results.quote})},this.init()}]),angular.module("svgChartsApp").directive("svgChart",["$window","$mdMedia","LineChart","OHLCChart",function(a,b,c,d){return{scope:{symbol:"=",selectedExtras:"=",selectedChart:"=",positions:"="},template:'<svg class="svg-chart"><g name="svgContent" class="svg-chart-content"></g></svg>',link:function(e,f){e.svg=d3.select(f[0].querySelector(".svg-chart")).attr("name","svgChart").attr("style","background-color:#fff"),e.svgContent=e.svg.selectAll(".svg-chart-content"),e.margin={top:20,right:40,bottom:30,left:0},e.gradient=e.svgContent.append("svg:defs").append("svg:linearGradient").attr("id","gradient").attr("x1","100%").attr("y1","100%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),e.gradient.append("svg:stop").attr("offset","0%").attr("stop-color","#fff").attr("stop-opacity",1),e.gradient.append("svg:stop").attr("offset","100%").attr("stop-color","#b8e1fc").attr("stop-opacity",1),e.chartArea=e.svgContent.append("path").attr("name","chartArea").style("fill","url(#gradient)"),e.chartLine=e.svgContent.append("path").attr("name","chartLine"),e.bollingerBandArea=e.svgContent.append("svg:path").attr("class","bollinger-band-area").attr("style","fill: grey;").attr("fill-opacity",.2),e.bollingerBandHigh=e.svgContent.append("svg:path").attr("class","band bollinger-band-high").attr("style","stroke: black; fill: none;"),e.bollingerBandLow=e.svgContent.append("svg:path").attr("class","band bollinger-band-low").attr("style","stroke: black; fill: none;"),e.movingAvgLine=e.svgContent.append("svg:path").attr("class","moving-average").attr("style","stroke: #FF9900; fill: none;"),e.xAxis=e.svgContent.append("g").attr("name","xAxis"),e.yAxis=e.svgContent.append("g").attr("name","yAxis"),e.horizontalGrid=e.svgContent.append("g").attr("name","horizontalGrid"),e.verticalGrid=e.svgContent.append("g").attr("name","verticalGrid"),e.parseDate=d3.time.format("%Y-%m-%d").parse,e.renderBollingerBands=function(){var a=d3.svg.line().x(function(a,b){return e.x(a.date)}).y(function(a,b){return e.y(a.Low)}).interpolate(g(3)),b=d3.svg.area().x(function(a){return e.x(a.date)}).y0(function(a){return e.y(a.Low)}).y1(function(a){return e.y(a.High)}).interpolate(g(3)),c=d3.svg.line().x(function(a,b){return e.x(a.date)}).y(function(a,b){return e.y(a.High)}).interpolate(g(3));e.bollingerBandLow.transition().duration(500).ease("linear").attr("d",a(e.symbol.historicalData)),e.bollingerBandHigh.transition().duration(500).ease("linear").attr("d",c(e.symbol.historicalData)),e.bollingerBandArea.transition().duration(500).ease("linear").attr("d",b(e.symbol.historicalData))},e.getBollingerBands=function(a,b,c){for(var d=[],e=a-1,f=c.length;f>e;e++){var g=c.slice(e+1-a,e),h=d3.mean(g,function(a){return a.close}),i=Math.sqrt(d3.mean(g.map(function(a){return Math.pow(a.close-h,2)})));d.push({date:c[e].date,ma:h,low:h-b*i,high:h+b*i})}return d},e.resizeScene=function(){e.symbol.historicalData.forEach(function(a){a.date=e.parseDate(a.Date),a.close=+a.Close,a.low=+a.Low}),e.width=f.parent()[0].offsetWidth-e.margin.left-e.margin.right,e.height=f.parent()[0].offsetHeight-e.margin.top-e.margin.bottom,e.x=d3.time.scale().range([0,e.width]),e.y=d3.scale.linear().range([e.height,0]),e.x.domain(d3.extent(e.symbol.historicalData,function(a){return a.date}));var a=20,b=2;e.getBollingerBands(a,b,e.symbol.historicalData);e.y.domain(d3.extent(e.symbol.historicalData,function(a){return a.close})),e.svg.attr("width",e.width+e.margin.left+e.margin.right).attr("height",e.height+e.margin.top+e.margin.bottom),e.svgContent.attr("transform","translate("+e.margin.left+","+e.margin.top+")")},e.renderPositions=function(){},e.renderXYAxis=function(){var a=d3.svg.axis().scale(e.x).orient("bottom");(b("sm")||b("md"))&&a.ticks(5);var c=d3.svg.axis().scale(e.y).orient("right");e.xAxis.attr("class","x axis").attr("transform","translate(0,"+e.height+")").call(a).attr({fill:"none","shape-rendering":"crispEdges",stroke:"rgba(0,0,0,0.54)"}),e.yAxis.attr("class","y axis").attr("transform","translate("+e.width+",0)").call(c).attr({fill:"none","shape-rendering":"crispEdges",stroke:"rgba(0,0,0,0.54)"}),e.horizontalGrid.selectAll("line").remove();var d=e.horizontalGrid.selectAll("line").data(e.y.ticks(4));d.enter().append("line").attr({"class":"horizontalGrid",x1:0,x2:e.width,y1:function(a){return e.y(a)},y2:function(a){return e.y(a)},fill:"none","shape-rendering":"crispEdges",stroke:"#C7C7C7","stroke-width":"1px","stroke-dasharray":"5, 5"}),d.exit().remove(),e.verticalGrid.selectAll("line").remove();var f=e.verticalGrid.selectAll("line").data(e.x.ticks(12));f.enter().append("line").attr({"class":"verticalGrid",x1:function(a){return e.x(a)},x2:function(a){return e.x(a)},y1:-e.margin.top,y2:e.height,fill:"none","shape-rendering":"crispEdges",stroke:"#C7C7C7","stroke-width":"1px","stroke-dasharray":"5, 5"}),f.exit().remove(),e.xAxis.selectAll("text").attr("style","fill:black; stroke: 0px;"),e.yAxis.selectAll("text").attr("style","fill:black; stroke: 0px;")};var g=function(a){return function(b){b=b.map(function(c,d,e){var f,g,h=d+a-1;return h<b.length?(f=e.slice(d,h+1),g=f.reduce(function(a,b){return[a[0]+b[0],a[1]+b[1]]}),g.map(function(b){return b/a})):void 0}),b=b.filter(function(a){return"undefined"!=typeof a});var c=d3.svg.line().interpolate("basis")(b);return c.slice(1,c.length)}};e.renderMovingAverage=function(){var a=d3.svg.line().x(function(a,b){return e.x(a.date)}).y(function(a,b){return e.y(a.close)}).interpolate(g(3));e.movingAvgLine.transition().duration(500).ease("linear").attr("d",a(e.symbol.historicalData))},e.render=function(){e.resizeScene(),"ohlc-chart"===e.selectedChart?(d.cleanUp(),c.cleanUp(),d.render(e,e.symbol.historicalData)):"candlestick-chart"===e.selectedChart?(d.cleanUp(),c.cleanUp(),d.render(e,e.symbol.historicalData,!0)):(c.cleanUp(),d.cleanUp(),c.render(e,e.symbol.historicalData)),e.selectedExtras&&e.selectedExtras.toString().indexOf("moving-average")>-1?e.renderMovingAverage():e.movingAvgLine.attr("d",function(){}),e.selectedExtras&&e.selectedExtras.toString().indexOf("bollinger-bands")>-1?e.renderBollingerBands():(e.bollingerBandHigh.attr("d",function(){}),e.bollingerBandLow.attr("d",function(){}),e.bollingerBandArea.attr("d",function(){})),e.renderXYAxis()},e.$watch(function(){return e.symbol&&e.symbol.historicalData?JSON.stringify([e.symbol.historicalData,e.selectedChart,e.selectedExtras]):void 0},function(){e.symbol&&e.symbol.historicalData&&e.symbol.historicalData.length>0&&e.render()},!0),angular.element(a).on("resize",function(){e.symbol&&e.symbol.historicalData&&e.symbol.historicalData.length>0&&e.render()})}}}]),angular.module("svgChartsApp").factory("LineChart",function(){var a={};return a.cleanUp=function(){a.area&&a.area.attr("d",function(){}),a.chartLine&&a.chartLine.attr("d",function(){})},a.render=function(b,c){a.chartLine||(a.chartLine=b.chartLine),a.area||(a.area=b.chartArea);var d=d3.svg.line().x(function(a){return b.x(a.date)}).y(function(a){return b.y(a.close)}),e=d3.svg.area().x(function(a){return b.x(a.date)}).y0(b.height).y1(function(a){return b.y(a.close)});a.area.datum(c).transition().duration(500).ease("linear").attr("class","area").attr("d",e),a.chartLine.datum(c).transition().duration(500).ease("linear").attr("class","line").attr("d",d).attr("style","fill: none;stroke: steelblue;stroke-width: 1.5px;")},a}),angular.module("svgChartsApp").factory("OHLCChart",function(){var a={};a.cleanUp=function(){if(a.bars&&a.bars.selectAll(".bar")){var b=a.bars.selectAll(".bar");b.selectAll(".high-low-line").attr("d",function(){}),b.selectAll(".open-tick").attr("d",function(){}),b.selectAll(".close-tick").attr("d",function(){}),b.selectAll("rect").remove()}};var b=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}),c=function(a){return a.close>a.Open},d=function(a,d){var e,f,g=5;e=d.selectAll(".open-tick").data(function(a){return[a]}),f=d.selectAll(".close-tick").data(function(a){return[a]}),e.enter().append("path"),f.enter().append("path"),e.classed("open-tick",!0).transition().duration(500).ease("linear").attr("d",function(c){return b([{x:a.x(c.date)-g,y:a.y(c.Open)},{x:a.x(c.date),y:a.y(c.Open)}])}).attr({stroke:function(a){return c(a)?"green":"red"}}),f.classed("close-tick",!0).transition().duration(500).ease("linear").attr("d",function(c){return b([{x:a.x(c.date),y:a.y(c.close)},{x:a.x(c.date)+g,y:a.y(c.close)}])}).attr({stroke:function(a){return c(a)?"green":"red"}})},e=function(a,b){var d,e,f,g=3,h=200,i=200;d=b.selectAll("rect").data(function(a){return[a]}),d.enter().append("rect"),d.on("click",function(b){var c=d3.mouse(a.svg.node());e=c[0],f=c[1],(a.popoverText||a.popoverTextBox)&&(a.popoverText.remove(),a.popoverTextBox.remove()),f+i>a.height&&(f-=i),e+h>a.width&&(e-=h),a.popoverTextBox=a.svg.append("rect").attr("x",e).attr("y",f).attr("width",h).attr("height",i).attr("fill","grey"),a.popoverText=a.svg.append("text").attr("x",e).attr("y",f).attr("class","popover-text").attr("name","popover-text").text(function(){return"Date: "+b.Date+" Open: "+b.Open+" High: "+b.High+" Low: "+b.Low+" Close: "+b.Close}).attr("font-family","sans-serif").attr("font-size","20px").attr("fill","black")}),d.transition().duration(500).ease("linear").attr("x",function(b){return a.x(b.date)-g}).attr("y",function(b){return c(b)?a.y(b.close):a.y(b.Open)}).attr("style","cursor:pointer;").attr("width",2*g).attr("height",function(b){return c(b)?a.y(b.Open)-a.y(b.close):a.y(b.close)-a.y(b.Open)})};return a.render=function(f,g,h){a.bars=f.svgContent;var i=f.svgContent.selectAll(".bar").data(g,function(a){return a.date});i.enter().append("g").classed("bar",!0),i.attr({fill:function(a){return c(a)?"green":"red"}});var j=i.selectAll(".high-low-line").data(function(a){return[a]});j.enter().append("path"),j.classed("high-low-line",!0).transition().duration(500).ease("linear").attr("d",function(a){return b([{x:f.x(a.date),y:f.y(a.High)},{x:f.x(a.date),y:f.y(a.Low)}])}).attr({stroke:function(a){return c(a)?"green":"red"}}),h?e(f,i):d(f,i)},a}),angular.module("svgChartsApp").run(["$templateCache",function(a){a.put("views/routes/main.html",'<div style="height:500px"> <svg-chart positions="{}" selected-extras="ctrl.selectedExtras" selected-chart="ctrl.selectedChart" symbol="ctrl.symbol"> </svg-chart> </div>')}]);